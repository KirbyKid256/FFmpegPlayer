name: CMake Multi-Platform

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  win64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Submodules
        run: |
          sudo apt install g++-mingw-w64-x86-64-posix
          sudo apt install gcc-mingw-w64-x86-64-posix
          sudo apt-get update -qq && sudo apt-get -y install libass-dev libgnutls28-dev libmp3lame-dev libsdl2-dev libva-dev libvdpau-dev libvorbis-dev libxcb-xfixes0-dev meson ninja-build pkg-config yasm
          git submodule init
          git submodule update
      - name: Configure FFmpeg
        run: |
          cd FFmpeg
          ./configure --enable-shared --disable-static --disable-zlib --disable-programs --disable-doc --disable-manpages --disable-podpages --disable-txtpages --disable-ffplay --disable-ffprobe --disable-ffmpeg --arch=x86_64 --target-os=mingw32 --cross-prefix=x86_64-w64-mingw32-
          make
      - name: Package Libraries
        run: |
          mkdir libs
          mv ./FFmpeg/libavcodec/avcodec-61.dll ./libs/avcodec-61.dll
          mv ./FFmpeg/libavfilter/avfilter-10.dll ./libs/avfilter-10.dll
          mv ./FFmpeg/libavformat/avformat-61.dll ./libs/avformat-61.dll
          mv ./FFmpeg/libavutil/avutil-59.dll ./libs/avutil-59.dll
          mv ./FFmpeg/libswresample/swresample-5.dll ./libs/swresample-5.dll
          mv ./FFmpeg/libswscale/swscale-8.dll ./libs/swscale-8.dll
      - name: Upload Libraries
        uses: actions/upload-artifact@v4
        with:
          name: lib-windows
          path: libs
      - name: Generate Bindings
        run: |
          cd godot-cpp
          cmake ./CMakeLists.txt -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=../mingw-w64-x86_64.cmake
          make
      - name: Build GDExtension
        run: |
          cmake ./CMakeLists.txt -DCMAKE_TOOLCHAIN_FILE=./mingw-w64-x86_64.cmake
          make
      - name: Upload GDExtension
        uses: actions/upload-artifact@v4
        with:
          name: bin-windows
          path: bin/win64
  linux64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Submodules
        run: |
          sudo apt-get update -qq && sudo apt-get -y install libass-dev libgnutls28-dev libmp3lame-dev libsdl2-dev libva-dev libvdpau-dev libvorbis-dev libxcb-xfixes0-dev meson ninja-build pkg-config yasm
          git submodule init
          git submodule update
      - name: Configure FFmpeg
        run: |
          cd FFmpeg
          ./configure --enable-pthreads --enable-shared --disable-static --disable-zlib --disable-programs --disable-doc --disable-manpages --disable-podpages --disable-txtpages --disable-ffplay --disable-ffprobe --disable-ffmpeg --arch=x86_64
          make
      - name: Package Libraries
        run: |
          mkdir libs
          mv ./FFmpeg/libavcodec/libavcodec.so.61 ./libs/libavcodec.so.61
          mv ./FFmpeg/libavfilter/libavfilter.so.10 ./libs/libavfilter.so.10
          mv ./FFmpeg/libavformat/libavformat.so.61 ./libs/libavformat.so.61
          mv ./FFmpeg/libavutil/libavutil.so.59 ./libs/libavutil.so.59
          mv ./FFmpeg/libswresample/libswresample.so.5 ./libs/libswresample.so.5
          mv ./FFmpeg/libswscale/libswscale.so.8 ./libs/libswscale.so.8
      - name: Upload Libraries
        uses: actions/upload-artifact@v4
        with:
          name: lib-linux
          path: libs
      - name: Generate Bindings
        run: |
          cd godot-cpp
          cmake ./CMakeLists.txt -DCMAKE_BUILD_TYPE=Release
          make
      - name: Build GDExtension
        run: |
          cmake ./CMakeLists.txt
          make
      - name: Upload GDExtension
        uses: actions/upload-artifact@v4
        with:
          name: bin-linux
          path: bin/x11
  macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Submodules
        run: |
          brew install yasm automake fdk-aac lame libass libtool libvorbis libvpx opus sdl12-compat shtool texi2html theora x264 x265 xvid nasm
          git submodule init
          git submodule update
      - name: Configure FFmpeg
        run: |
          cd FFmpeg
          ./configure --enable-pthreads --enable-shared --disable-static --disable-zlib --disable-programs --disable-doc --disable-manpages --disable-podpages --disable-txtpages --disable-ffplay --disable-ffprobe --disable-ffmpeg --arch=x86_64 --cc='clang -arch x86_64'
          make
      - name: Package Libraries
        run: |
          mkdir libs
          mv ./FFmpeg/libavcodec/libavcodec.61.dylib ./libs/libavcodec.61.dylib
          mv ./FFmpeg/libavfilter/libavfilter.10.dylib ./libs/libavfilter.10.dylib
          mv ./FFmpeg/libavformat/libavformat.61.dylib ./libs/libavformat.61.dylib
          mv ./FFmpeg/libavutil/libavutil.59.dylib ./libs/libavutil.59.dylib
          mv ./FFmpeg/libswresample/libswresample.5.dylib ./libs/libswresample.5.dylib
          mv ./FFmpeg/libswscale/libswscale.8.dylib ./libs/libswscale.8.dylib
      - name: Upload Libraries
        uses: actions/upload-artifact@v4
        with:
          name: lib-macos
          path: libs
      - name: Generate Bindings
        run: |
          cd godot-cpp
          cmake ./CMakeLists.txt -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=x86_64
          make
      - name: Build GDExtension
        run: |
          cmake ./CMakeLists.txt
          make
      - name: Upload GDExtension
        uses: actions/upload-artifact@v4
        with:
          name: bin-macos
          path: bin/macos
